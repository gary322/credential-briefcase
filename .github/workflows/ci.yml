name: ci

on:
  push:
  pull_request:

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        shell: bash
        run: corepack enable

      - name: pnpm install
        shell: bash
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
        run: pnpm install --frozen-lockfile

      - name: Generate OpenAPI clients (must be committed)
        shell: bash
        run: |
          pnpm -r gen
          git diff --exit-code

      - name: pnpm lint
        shell: bash
        run: pnpm -r lint

      - name: pnpm test
        shell: bash
        run: pnpm -r test

      - name: briefcase-extension build artifacts (must be committed)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          pnpm -C apps/briefcase-extension build
          git diff --exit-code

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.89.0"
          components: rustfmt, clippy

      - name: Cargo fmt
        run: cargo fmt --all -- --check

      - name: Cargo clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Cargo test
        run: cargo test --all

      - name: briefcase-keys (apple backend)
        if: matrix.os == 'macos-latest'
        run: cargo test -p briefcase-keys --features apple apple_

      - name: briefcase-keys (windows backend)
        if: matrix.os == 'windows-latest'
        run: cargo test -p briefcase-keys --features windows windows_

  extension_e2e:
    name: extension e2e (playwright)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        shell: bash
        run: corepack enable

      - name: pnpm install
        shell: bash
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
        run: pnpm install --frozen-lockfile

      - name: Build extension
        shell: bash
        run: pnpm -C apps/briefcase-extension build

      - name: Install Playwright Chromium
        shell: bash
        run: pnpm -C apps/briefcase-extension exec playwright install --with-deps chromium

      - name: Playwright tests
        shell: bash
        run: pnpm -C apps/briefcase-extension test:e2e

  pkcs11:
    name: pkcs11 (SoftHSM)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build SoftHSM test image
        run: docker build -f docker/softhsm/Dockerfile -t credential-briefcase-softhsm .

      - name: Run PKCS#11 tests (SoftHSM)
        run: docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace credential-briefcase-softhsm bash docker/softhsm/run-tests.sh

  tpm2:
    name: tpm2 (swtpm)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build swtpm test image
        run: docker build -f docker/swtpm/Dockerfile -t credential-briefcase-swtpm .

      - name: Run TPM2 tests (swtpm)
        run: docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace credential-briefcase-swtpm bash docker/swtpm/run-tests.sh

  x402:
    name: x402 (stablecoin v2)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build x402 harness image
        run: docker build -f docker/x402-harness/Dockerfile -t credential-briefcase-x402 .

      - name: Run x402 v2 harness
        run: docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace credential-briefcase-x402 bash docker/x402-harness/run-tests.sh

  lightning:
    name: lightning (L402 regtest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.89.0"
          components: rustfmt, clippy

      - name: Run Lightning regtest harness
        run: bash docker/lightning-regtest/run-tests.sh all

  enterprise_control_plane:
    name: enterprise control plane (Postgres e2e)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.89.0"
          components: rustfmt, clippy

      - name: Enterprise e2e harness
        run: bash docker/enterprise/run-tests.sh

  ios_signer_build:
    name: iOS signer (build)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install xcodegen
        run: brew install xcodegen

      - name: Generate Xcode project
        working-directory: apps/briefcase-mobile-signer/ios
        run: xcodegen generate

      - name: xcodebuild (iOS Simulator)
        working-directory: apps/briefcase-mobile-signer/ios
        run: |
          xcodebuild \
            -project BriefcaseMobileSigner.xcodeproj \
            -scheme BriefcaseMobileSigner \
            -destination 'generic/platform=iOS Simulator' \
            CODE_SIGNING_ALLOWED=NO \
            build

  android_signer_build:
    name: Android signer (build)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Install Android SDK packages
        shell: bash
        run: |
          set -euo pipefail
          yes | sdkmanager --licenses >/dev/null
          sdkmanager --install \
            "platforms;android-34" \
            "build-tools;34.0.0"

      - name: Assemble debug
        working-directory: apps/briefcase-mobile-signer/android
        run: ./gradlew :app:assembleDebug --stacktrace --no-daemon
