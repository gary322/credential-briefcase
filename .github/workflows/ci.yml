name: ci

on:
  push:
  pull_request:

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        shell: bash
        run: corepack enable

      - name: pnpm install
        shell: bash
        run: pnpm install --frozen-lockfile

      - name: Generate OpenAPI clients (must be committed)
        shell: bash
        run: |
          pnpm -r gen
          git diff --exit-code

      - name: pnpm lint
        shell: bash
        run: pnpm -r lint

      - name: pnpm test
        shell: bash
        run: pnpm -r test

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.89.0"
          components: rustfmt, clippy

      - name: Cargo fmt
        run: cargo fmt --all -- --check

      - name: Cargo clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Cargo test
        run: cargo test --all

      - name: briefcase-keys (apple backend)
        if: matrix.os == 'macos-latest'
        run: cargo test -p briefcase-keys --features apple apple_

      - name: briefcase-keys (windows backend)
        if: matrix.os == 'windows-latest'
        run: cargo test -p briefcase-keys --features windows windows_

  pkcs11:
    name: pkcs11 (SoftHSM)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build SoftHSM test image
        run: docker build -f docker/softhsm/Dockerfile -t credential-briefcase-softhsm .

      - name: Run PKCS#11 tests (SoftHSM)
        run: docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace credential-briefcase-softhsm bash docker/softhsm/run-tests.sh

  tpm2:
    name: tpm2 (swtpm)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build swtpm test image
        run: docker build -f docker/swtpm/Dockerfile -t credential-briefcase-swtpm .

      - name: Run TPM2 tests (swtpm)
        run: docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace credential-briefcase-swtpm bash docker/swtpm/run-tests.sh
