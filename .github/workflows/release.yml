name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write
  packages: write

jobs:
  rust:
    name: rust binaries (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.89.0"

      - name: Build
        # Keep this a single line so it runs under both bash (unix) and pwsh (Windows).
        run: cargo build --release -p briefcased -p briefcase-cli -p mcp-gateway -p agent-access-gateway -p briefcase-ui -p briefcase-payment-helper -p briefcase-control-plane

      - name: Package (unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          name="credential-briefcase-${GITHUB_REF_NAME}-${RUNNER_OS}"
          mkdir -p "dist/${name}"
          cp target/release/briefcased "dist/${name}/"
          cp target/release/briefcase-cli "dist/${name}/"
          cp target/release/mcp-gateway "dist/${name}/"
          cp target/release/agent-access-gateway "dist/${name}/"
          cp target/release/briefcase-ui "dist/${name}/"
          cp target/release/briefcase-payment-helper "dist/${name}/"
          cp target/release/briefcase-control-plane "dist/${name}/"
          tar -C dist -czf "dist/${name}.tar.gz" "${name}"

      - name: Package (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $name = "credential-briefcase-$env:GITHUB_REF_NAME-$env:RUNNER_OS"
          New-Item -ItemType Directory -Force -Path "dist/$name" | Out-Null
          Copy-Item "target/release/briefcased.exe" "dist/$name/"
          Copy-Item "target/release/briefcase-cli.exe" "dist/$name/"
          Copy-Item "target/release/mcp-gateway.exe" "dist/$name/"
          Copy-Item "target/release/agent-access-gateway.exe" "dist/$name/"
          Copy-Item "target/release/briefcase-ui.exe" "dist/$name/"
          Copy-Item "target/release/briefcase-payment-helper.exe" "dist/$name/"
          Copy-Item "target/release/briefcase-control-plane.exe" "dist/$name/"
          Compress-Archive -Path "dist/$name" -DestinationPath "dist/$name.zip"

      - name: Upload artifacts
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-artifacts
          path: dist/*.tar.gz

      - name: Upload artifacts (windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-artifacts
          path: dist/*.zip

  extension:
    name: browser extension
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        shell: bash
        run: corepack enable

      - name: pnpm install
        shell: bash
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
        run: pnpm install --frozen-lockfile

      - name: Build extension
        shell: bash
        run: pnpm -C apps/briefcase-extension build

      - name: Package extension
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          name="briefcase-extension-${GITHUB_REF_NAME}"
          (cd apps/briefcase-extension/extension && zip -r "../../../dist/${name}.zip" .)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-artifacts
          path: dist/*.zip

  mobile_android:
    name: Android signer (build)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Install Android SDK packages
        shell: bash
        run: |
          set -euo pipefail
          yes | sdkmanager --licenses >/dev/null
          sdkmanager --install \
            "platforms;android-34" \
            "build-tools;34.0.0"

      - name: Assemble debug
        working-directory: apps/briefcase-mobile-signer/android
        run: ./gradlew :app:assembleDebug --stacktrace --no-daemon

      - name: Package APK
        shell: bash
        run: |
          set -euo pipefail
          apk="apps/briefcase-mobile-signer/android/app/build/outputs/apk/debug/app-debug.apk"
          test -f "${apk}"
          mkdir -p dist
          name="briefcase-mobile-signer-android-${GITHUB_REF_NAME}"
          zip -j "dist/${name}.zip" "${apk}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mobile-android-artifacts
          path: dist/*.zip

  mobile_ios:
    name: iOS signer (build)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install xcodegen
        run: brew install xcodegen

      - name: Generate Xcode project
        working-directory: apps/briefcase-mobile-signer/ios
        run: xcodegen generate

      - name: xcodebuild (iOS Simulator)
        working-directory: apps/briefcase-mobile-signer/ios
        run: |
          xcodebuild \
            -project BriefcaseMobileSigner.xcodeproj \
            -scheme BriefcaseMobileSigner \
            -destination 'generic/platform=iOS Simulator' \
            -derivedDataPath build/derived \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Package app
        shell: bash
        run: |
          set -euo pipefail
          app="apps/briefcase-mobile-signer/ios/build/derived/Build/Products/Debug-iphonesimulator/BriefcaseMobileSigner.app"
          test -d "${app}"
          mkdir -p dist
          name="briefcase-mobile-signer-ios-${GITHUB_REF_NAME}"
          out="${GITHUB_WORKSPACE}/dist/${name}.zip"
          (cd "$(dirname "${app}")" && zip -r "${out}" "BriefcaseMobileSigner.app")

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mobile-ios-artifacts
          path: dist/*.zip

  control_plane_container:
    name: control plane container (GHCR)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/credential-briefcase-control-plane
          tags: |
            type=ref,event=tag
            type=raw,value=latest

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/control-plane/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign image (keyless)
        shell: bash
        run: |
          set -euo pipefail
          image="ghcr.io/${{ github.repository_owner }}/credential-briefcase-control-plane"
          cosign sign --yes "${image}@${{ steps.build.outputs.digest }}"

      - name: Write image digest file
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          image="ghcr.io/${{ github.repository_owner }}/credential-briefcase-control-plane"
          echo "${image}@${{ steps.build.outputs.digest }}" > "dist/control-plane-image-${GITHUB_REF_NAME}.txt"

      - name: Upload digest artifact
        uses: actions/upload-artifact@v4
        with:
          name: control-plane-image
          path: dist/*.txt

  sbom:
    name: sbom (SPDX JSON)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare dist dir
        run: mkdir -p dist

      - name: Generate SBOM (repository)
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          output-file: dist/sbom-${{ github.ref_name }}.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: dist/*.json

  publish:
    runs-on: ubuntu-latest
    needs:
      - rust
      - extension
      - mobile_android
      - mobile_ios
      - control_plane_container
      - sbom
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Generate checksums
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          find . -type f \( -name '*.tar.gz' -o -name '*.zip' -o -name '*.json' -o -name '*.txt' \) -print0 | xargs -0 sha256sum > SHA256SUMS.txt

      - name: Sign artifacts (keyless)
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          while IFS= read -r f; do
            cosign sign-blob --yes --output-signature "${f}.sig" --output-certificate "${f}.crt" "${f}"
          done < <(find . -type f \( -name '*.tar.gz' -o -name '*.zip' -o -name '*.json' -o -name '*.txt' \) -print)

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/SHA256SUMS.txt
            dist/**/*.tar.gz
            dist/**/*.tar.gz.sig
            dist/**/*.tar.gz.crt
            dist/**/*.zip
            dist/**/*.zip.sig
            dist/**/*.zip.crt
            dist/**/*.json
            dist/**/*.json.sig
            dist/**/*.json.crt
            dist/**/*.txt
            dist/**/*.txt.sig
            dist/**/*.txt.crt
